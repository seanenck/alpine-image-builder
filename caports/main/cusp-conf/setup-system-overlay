#!/bin/sh -e
OVERLAY="/media/root-ro"
CONF=/etc/default/grub
if [ -d "$OVERLAY" ]; then
  echo "$OVERLAY already setup"
  exit 1 
fi

apk add arch-chroot

if grep "GRUB_CMDLINE_LINUX" "$CONF" | grep -q "overlaytmpfs"; then
  echo "cmdline already set"
else
  echo "updating cmdline"
  sed -i "s/^GRUB_CMDLINE_LINUX=\"/GRUB_CMDLINE_LINUX=\"overlaytmpfs /g" "$CONF"
fi

grub-mkconfig -o /boot/grub/grub.cfg
